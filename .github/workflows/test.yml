name: Project Quality Check

on: [push, pull_request]

jobs:
  run-tests:
    runs-on: ubuntu-latest
    steps:
      - name: Download Code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install Project & Testing Tools
        run: |
          python -m pip install --upgrade pip
          # 1. Clean up everything first
          rm -rf build/ dist/ *.egg-info src/*.egg-info .pytest_cache
          
          # 2. FORCE REINSTALL EVERYTHING, IGNORE WHAT THE RUNNER ALREADY HAS
          # This is the "Nuclear" pip command to fix corrupted site-packages
          pip install --no-cache-dir --upgrade --force-reinstall --ignore-installed \
            PyYAML pytest ruamel.yaml argcomplete rich==14.2.0
          
          # 3. Link your project source
          pip install --no-cache-dir --no-deps -e .

      - name: DEBUG - Verify Installation  # ← NEW: See what's WRONG
        run: |
          echo "=== PYTHON PATH ==="
          which python
          python --version
          echo "=== INSTALLED PACKAGES ==="
          pip list | grep -E "(yaml|rich|kubecuro)"
          echo "=== TEST IMPORTS ==="
          python -c "import rich; print('Rich location:', rich.__file__)"
          python -c "from rich.console import Console; print('✅ Console found in:', Console.__module__)" || echo "❌ Console MISSING"
          python -c "import yaml; print('✅ PyYAML OK')"
          python -c "import kubecuro; print('✅ KUBECURO OK')" || echo "❌ KUBECURO FAILED"
          echo "=== TEST KUBECURO MAIN ==="
          python -m kubecuro.main --help || echo "❌ KUBECURO.MAIN FAILED"

      - name: Environment Truth-Check
        run: |
          python -m pip show rich
          python --version

      - name: Clean Cache and Run Tests
        run: |
          # 1. Final cleanup of potential import blockers
          find . -name "*.pyc" -delete
          find . -name "__pycache__" -delete
          
          # 2. RUN PYTEST WITH FORCED PATHING
          # We set PYTHONPATH to 'src' so 'import kubecuro' works, 
          # but we run it as a module to ensure site-packages are correct.
          export PYTHONPATH=$PYTHONPATH:$(pwd)/src
          python3 -m pytest tests/test_logic.py -v --tb=long
