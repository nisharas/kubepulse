name: Project Quality Check

on: [push, pull_request]

jobs:
  run-tests:
    runs-on: ubuntu-latest
    steps:
      - name: Download Code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install Project & Testing Tools
        run: |
          python -m pip install --upgrade pip
          # Remove any stale metadata that causes Namespace collisions
          rm -rf src/*.egg-info build/ .pytest_cache
          # 1. Install core dependencies first
          pip install --no-cache-dir PyYAML pytest          
          # 2. Install your project in editable mode
          # Install the project WITHOUT dependencies to avoid clobbering
          # This prevents the requirements.txt/pyproject.toml from messing with Rich
          pip install --no-cache-dir --no-deps -e .
          # 3. Force REINSTALL rich LAST to ensure the correct version wins
          pip install --no-cache-dir --force-reinstall rich==14.2.0

      - name: DEBUG - Verify Installation  # ← NEW: See what's WRONG
        run: |
          echo "=== PYTHON PATH ==="
          which python
          python --version
          echo "=== INSTALLED PACKAGES ==="
          pip list | grep -E "(yaml|rich|kubecuro)"
          echo "=== TEST IMPORTS ==="
          python -c "from rich.console import Console; print('✅ Rich Console OK')"
          python -c "import yaml; print('✅ PyYAML OK')"
          python -c "import kubecuro; print('✅ KUBECURO OK')" || echo "❌ KUBECURO FAILED"
          echo "=== TEST KUBECURO MAIN ==="
          python -m kubecuro.main --help || echo "❌ KUBECURO.MAIN FAILED"

      - name: Environment Truth-Check
        run: |
          python -m pip show rich
          python --version

      - name: Clean Cache and Run Tests
        run: |
          find . -name "*.pyc" -delete
          find . -name "__pycache__" -delete
          python -m pytest tests/ -v --tb=short
