name: Project Quality Check

on: [push, pull_request]

jobs:
  run-tests:
    runs-on: ubuntu-latest
    steps:
      - name: Download Code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install Project & Testing Tools
        run: |
          python -m pip install --upgrade pip
          # 1. Install core dependencies first
          pip install -r requirements.txt
          pip install PyYAML pytest          
          # 2. Install your project in editable mode
          pip install -e .
          # 3. Force REINSTALL rich LAST to ensure the correct version wins
          pip install --force-reinstall rich==14.2.0

      - name: DEBUG - Verify Installation  # ← NEW: See what's WRONG
        run: |
          echo "=== PYTHON PATH ==="
          which python
          python --version
          echo "=== INSTALLED PACKAGES ==="
          pip list | grep -E "(yaml|rich|kubecuro)"
          echo "=== TEST IMPORTS ==="
          python -c "import yaml; print('✅ YAML OK:', yaml.__version__)" || echo "❌ YAML FAILED"
          python -c "import kubecuro; print('✅ KUBECURO OK')" || echo "❌ KUBECURO FAILED"
          echo "=== TEST KUBECURO MAIN ==="
          python -m kubecuro.main --help || echo "❌ KUBECURO.MAIN FAILED"

      - name: Environment Truth-Check
        run: |
          python -m pip show rich
          python --version

      - name: Clean Cache and Run Tests
        run: |
          find . -name "*.pyc" -delete
          find . -name "__pycache__" -delete
          python -m pytest tests/ -v --tb=short
